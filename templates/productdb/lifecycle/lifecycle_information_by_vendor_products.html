{% extends 'base.html' %}
{% load staticfiles %}

{% block title %}
Vendor product lifecycle information
{% endblock %}

{% block custom_css %}
    td.details-control {
        background: url('{% static 'images/details_open.png' %}') no-repeat center center;
        cursor: pointer;
    }
    tr.details td.details-control {
        background: url('{% static 'images/details_close.png' %}') no-repeat center center;
    }
{% endblock %}

{% block content %}
    <div class="container">
        <h1>Vendor product lifecycle information</h1>
        <p>On this page, you can search the database for product IDs, which are affected by an
            <strong>End of Life announcement</strong>. Please select a Vendor from the drop down
            list below. After that, you can use the search field on the table.
            To match against a list, please use the bulk tool.</p>
    </div>
    {% if vendors|length > 0 %}
    <div class="container">
        <div class="alert alert-info" role="alert">
            <strong>Please note: </strong>Only products which are affected by an
            End of Sale announcement or End of Sale date are displayed.
        </div>
        <form class="form-horizontal" method="post">
            <div class="form-group">
                <label for="vendor_selection" class="col-sm-2 control-label">Vendor: </label>
                <div class="col-sm-10">
                    <select class="form-control" id="vendor_selection" name="vendor_selection">
                    {% for ven in vendors %}
                    {% if vendor_selection %}
                        {% ifequal ven.id|add:"0" vendor_selection|add:"0" %}
                        <option value="{{ ven.id }}" selected>{{ ven.name }}</option>
                        {% else %}
                        <option value="{{ ven.id }}">{{ ven.name }}</option>
                        {% endifequal %}
                    {% else %}
                        <option value="{{ ven.id }}">{{ ven.name }}</option>
                    {% endif %}
                    {% endfor %}
                    </select>
                </div>
            </div>
            <div class="text-center">
                <input class="btn btn-default" type="submit" id="submit" value="view vendor product lifecycle information" />
            </div>
            {% csrf_token %}
        </form>
    </div>
    <hr>
    <div class="container">
        <table id="product_table" class="table table-striped table-hover" cellspacing="0" width="100%">
            <thead>
                <tr>
                    <th width="20px"></th>
                    <th>Product ID</th>
                    <th width="15%">End of Sale</th>
                    <th width="15%">End of SW Maintenance</th>
                    <th width="15%">End of Support</th>
                </tr>
            </thead>
            <tfoot>
                <tr>
                    <th></th>
                    <th>Product ID</th>
                    <th>End of Sale</th>
                    <th>End of SW Maintenance</th>
                    <th>End of Support</th>
                </tr>
            </tfoot>
        </table>
    </div>
    {% else %}
    <div class="container">
        <div class="alert alert-warning" role="alert">
            <strong>Warning:</strong> No vendor found in database.
        </div>
    </div>
    {% endif %}
{% endblock %}

{% block end_of_file_statments %}
    <script type="application/javascript">
        function format ( d ) {
            var details = '';
            details += "<strong>Description:</strong> " + d.description + "<br><br>";
            if (! (d.eol_reference_number === "" || d.eol_reference_number == null) ) {
                if (! (d.eol_reference_url === "" || d.eol_reference_url == null) ) {
                    details += '<strong>Product Bulletin: </strong><a href="' +
                            d.eol_reference_url+'" target="_blank">' +
                            d.eol_reference_number + '</a><br>';
                } else {
                    details += '<strong>Product Bulletin: </strong>' + d.eol_reference_number + '<br>';
                }
            }

            if (! (d.eol_ext_announcement_date === "" || d.eol_ext_announcement_date == null) ) {
                details += '<strong>EOX External Announcement Date: </strong> '+d.eol_ext_announcement_date+'<br>';
            }

            if (! (d.end_of_sw_maintenance_date === "" || d.end_of_sw_maintenance_date == null) ) {
                details += '<strong>End of SW Maintenance Releases: </strong> '+d.end_of_sw_maintenance_date+'<br>';
            }

            if (! (d.end_of_routine_failure_analysis === "" || d.end_of_routine_failure_analysis == null) ) {
                details += '<strong>End of Routine Failure Analysis: </strong> '+d.end_of_routine_failure_analysis+'<br>';
            }

            if (! (d.end_of_service_contract_renewal === "" || d.end_of_service_contract_renewal == null) ) {
                details += '<strong>End of Service Contract Renewal: </strong> '+d.end_of_service_contract_renewal+'<br>';
            }

            if (! (d.end_of_new_service_attachment_date === "" || d.end_of_new_service_attachment_date == null) ) {
                details += '<strong>End of New Service Attachment: </strong> '+d.end_of_new_service_attachment_date+'<br>';
            }

            return details;
        }
        $(document).ready(function() {
            if($('#vendor_selection').val() != null) {
                update_datatable()
            }
        });

        function update_datatable() {
            var product_table = $('#product_table');
            var dt = product_table.DataTable( {
                "lengthMenu": [ [25, 50, 100, -1], [25, 50, 100, "All"] ],
                "processing": true,
                "serverSide": true,
                fixedHeader: {
                    header: true,
                    footer: true
                },
                "columnDefs": [
                    {
                        "targets": 0,
                        "visible": true,
                        "searchable": false
                    },
                    {
                        "targets": 1,
                        "visible": true,
                        "searchable": true
                    },
                    {
                        "render": function ( data, type, row ) {
                            if(row['eol_ext_announcement_date'] == null) {
                                return "No data"
                            }
                            else {
                                return data
                            }
                        },
                        "targets": [2,3,4],
                        "visible": true,
                        "searchable": false
                    },
                    {
                        "targets": [5,6,7,8,9,10,11,12],
                        "visible": false,
                        "searchable": false
                    }
                ],
                "columns": [
                    {
                        "class":          "details-control",
                        "orderable":      false,
                        "data":           null,
                        "defaultContent": ""
                    },
                    { "data": "product_id" },
                    { "data": "end_of_sale_date" },
                    { "data": "end_of_sw_maintenance_date" },
                    { "data": "end_of_support_date" },
                    { "data": "description" },
                    { "data": "eol_ext_announcement_date" },
                    { "data": "end_of_routine_failure_analysis" },
                    { "data": "end_of_service_contract_renewal" },
                    { "data": "end_of_new_service_attachment_date" },
                    { "data": "end_of_support_date" },
                    { "data": "eol_reference_number" },
                    { "data": "eol_reference_url" }
                ],
                "order": [[1, 'asc']],
                "dom": "<'row'<'col-sm-6'l><'col-sm-6'f>>" +
                       "<'row'<'col-sm-12'tr>>" +
                       "<'row'<'col-sm-5'i><'col-sm-7'p>>",
                "ajax": {
                    "url": "{% url 'productdb:datatables_lifecycle_view' %}" + $('#vendor_selection').val() + "/"
                }
            });
            var detailRows = [];

            product_table.find('tbody').on( 'click', 'tr td.details-control', function () {
                var tr = $(this).closest('tr');
                var row = dt.row( tr );
                var idx = $.inArray( tr.attr('id'), detailRows );

                if ( row.child.isShown() ) {
                    tr.removeClass( 'details' );
                    row.child.hide();

                    // Remove from the 'open' array
                    detailRows.splice( idx, 1 );
                }
                else {
                    tr.addClass( 'details' );
                    row.child( format( row.data() ) ).show();

                    // Add to the 'open' array
                    if ( idx === -1 ) {
                        detailRows.push( tr.attr('id') );
                    }
                }
            } );

            // On each draw, loop over the `detailRows` array and show any child rows
            dt.on( 'draw', function () {
                $.each( detailRows, function ( i, id ) {
                    $('#' + id + ' td.details-control').trigger( 'click' );
                } );
            } );
        }
    </script>
{% endblock %}