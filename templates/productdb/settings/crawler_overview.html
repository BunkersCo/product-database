{% extends 'base.html' %}
{% load staticfiles %}

{% block title %}
Settings - Crawler overview
{% endblock %}

{% block custom_header %}
    {% if settings.eox_api_sync_task_id %}
        <META HTTP-EQUIV="refresh" CONTENT="5">
    {% endif %}
{% endblock %}

{% block content %}
    <div class="container">
        <div class="page-header">
            <h1>Crawler overview</h1>
        </div>
        <p>
            This pages provides an overview over the available crawler functions within the Product Database.
        </p>

        {% if settings.cisco_api_enabled %}
        <h2>Cisco API</h2>
        {% if settings.cisco_api_credentials_successful_tested %}
        <div class="alert alert-success" role="alert">
            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
            <span class="sr-only">Cisco API credentials working:</span>
            The Cisco Hello API is accessible using the credentials below{% if settings.cisco_api_credentials_last_message != "" %} ({{ settings.cisco_api_credentials_last_message }}){% endif %}.
        </div>
        {% else %}
        <div class="alert alert-danger" role="alert">
            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
            <span class="sr-only">Cisco API credentials not working:</span>
            Verification of the API access failed ({{ settings.cisco_api_credentials_last_message }}).
        </div>
        {% endif %}

        {% if settings.cisco_eox_api_auto_sync_enabled %}
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Periodic synchronization of the Cisco EoX states</h3>
            </div>
            <div class="panel-body">
                <p>With this panel, you can see the last execution state of the automatic Cisco EoX synchronization task.</p>
                <p><strong>Last execution time: </strong>{{ settings.cisco_eox_api_auto_sync_last_execution_time }}</p>
                <p><strong>Last execution results:</strong> <input class="btn btn-default btn-xs" type="button" onclick="return toggleMe('periodic_query_result_log')" value="show output"><br></p>
                <div id="periodic_query_result_log" style="display:none">
                    <pre style="font-family: monospace">{{ settings.cisco_eox_api_auto_sync_last_execution_result }}</pre>
                    <input class="btn btn-default btn-xs" type="button" onclick="return toggleMe('periodic_query_result_log')" value="hide output">
                </div>
                {% if settings.eox_api_sync_task_id %}
                <form>
                    <fieldset disabled>
                        <button type="submit" class="btn btn-default btn-block">perform synchronization... (page will refresh automatically)</button>
                    </fieldset>
                </form>
                {% else %}
                <a href="{% url 'productdb:schedule_cisco_eox_api_sync_now' %}?redirect_url={{ request.path }}" class="btn btn-default btn-block" role="button">Execute now</a>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% else %}
        <div class="alert alert-danger" role="alert">
            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
            <span class="sr-only">Cisco API disabled:</span>
            Please activate the Cisco API access on the <a href="{% url 'productdb:settings' %}">global configuration</a> page.
        </div>
        {% endif %}

        <h2>Backend State (Worker)</h2>
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Worker status</h3>
            </div>
            <div class="panel-body">
                <p>At least one active worker is required to get the scheduled tasks working.</p>
                {{ worker_status }}
            </div>
        </div>
    </div>
{% endblock %}

{% block end_of_file_statments %}
    <script type="text/javascript">
        function toggleMe(a){
            var e=document.getElementById(a);
            if(!e)return true;
                if(e.style.display=="none"){
                    e.style.display="block"
                }
            else{
                e.style.display="none"
            }
            return true;
        }
    </script>
{% endblock %}