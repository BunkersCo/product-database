---
  - name: register sourcecode path object
    stat: path={{ site_directory }}/{{ site_name }}/source
    register: source_file_exists

  - name: delete source directory (if existing)
    file: path={{ site_directory }}/{{ site_name }}/source state=absent
    when: (source_file_exists.stat.exists == True) and (system_source == "file")
  - name: copy source directory from local directory
    command: cp -rfu {{ site_source }} {{ site_directory }}/{{ site_name }}/source
    when: system_source == "file"

  - name: clone source directory from git repository
    git:
      repo={{ site_source }}
      dest={{ site_directory }}/{{ site_name }}/source
      version={{ site_source_branch }}
    when: system_source != "file"

  - name: modify rights on source directory (RWX)
    file: path={{ site_directory }}/{{ site_name }}/source
      state=directory
      recurse=yes
      mode=775
      owner={{ site_user }}
      group={{ site_group }}
    sudo: true
  - name: change permissions for nginx environment script
    file: path={{ site_directory }}/{{ site_name }}/source/build-scripts/appliance/script/configure_nginx.sh
      state=file
      mode=775
  - name: change permissions for gunicorn environment script
    file: path={{ site_directory }}/{{ site_name }}/source/build-scripts/appliance/script/configure_gunicorn.sh
      state=file
      mode=775
  - name: change permissions for the maintenance scripts
    file: path={{ site_directory }}/{{ site_name }}/source/build-scripts/appliance/script/configure_maintenance_scripts.sh
      state=file
      mode=775
  - name: update python requirements on the new virtualenv for the site
    pip:
      requirements={{ site_directory }}/{{ site_name }}/source/requirements.txt
      virtualenv={{ site_directory }}/{{ site_name }}/virtualenv
  - name: install psycopg2 for production environment
    pip:
      name=psycopg2 version=2.6.1
      virtualenv={{ site_directory }}/{{ site_name }}/virtualenv